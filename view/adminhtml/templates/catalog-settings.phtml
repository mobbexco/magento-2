<input type="hidden" name="mbbx_options_loaded" value="1" data-form-part="<?= $this->escapeHtml($this->form) ?>">

<?php

try {
    $id               = isset($this->params['id']) ? $this->params['id'] : 0;
    $advanced_plans   = $this->config->getCatalogSetting($id, 'advanced_plans', $this->type);
    $entity           = $this->config->getCatalogSetting($id, 'entity', $this->type);
    $show_featured    = $this->config->getCatalogSetting($id, 'show_featured', $this->type);
    $featured_plans   = $this->config->getCatalogSetting($id, 'featured_plans', $this->type);
    $manual_config    = $this->config->getCatalogSetting($id, 'manual_config', $this->type);
    $subscription_uid = $this->config->getCatalogSetting($id, 'subscription_uid', $this->type);
    $sourceFields = json_encode(\Mobbex\Repository::getPlansFilterFields($id));
} catch (\Exception $e) {
    $this->logger->log('error', "Mobbex: Error fetching catalog settings. {$e->getMessage()}");
}

/** TEMPLATE PLANS FILTER  */
?>
<div id="mbbx-plans-configurator" style="display:flex"></div>
<?php

/** TEMPLATE MULTIVENDOR */
?>
<div style="margin-top: 20px;">
    <h3><?= $this->escapeHtml(__('Split y Multivendor')) ?></h3>
    <p><?= $this->escapeHtml(__('Asocie otra entidad de Mobbex a este producto/categoría')) ?></p>
    <label for="entity"><?= $this->escapeHtml(__('UID de la entidad')) ?></label>
    <input id="entity" name="entity" type="text" value="<?= $this->escapeHtml($entity) ?>" data-form-part="<?= $this->escapeHtml($this->form) ?>">
</div>

<?php

/** TEMPLATE SUBSCRIPTION MODE */
if ($this->type == 'product') {
?>
    <div class="mbbx-subscription">
        <h3><?= $this->escapeHtml(__('Suscripciones')) ?></h3>
        <p><?= $this->escapeHtml(__('Asocie una suscripción existente a este producto')) ?></p>
        <div id="subscription_uid" style="margin-top: 20px;">
            <label style="margin-right: 10px;" for="sub_uid"><?= $this->escapeHtml(__('UID de la suscripción')) ?></label>
            <input type="text" name="sub_uid" id="sub_uid" value="<?= $this->escapeHtml($subscription_uid) ?>" data-form-part="<?= $this->escapeHtml($this->form) ?>">
        </div>
    </div>
<?php
}

$this->eventManager->dispatch('mobbex' . ucfirst($this->type) . 'Settings', false, $id);


/** STYLES */

?>
<style>
    .hidden {
        display: none;
    }

    .mbbx-subscription {
        margin-top: 20px;
    }
</style>
<script id="mbbx-finance-data">
    window.platformFormName        = "<?=$this->escapeHtml($this->form)?>";
    window.mobbexSources           = <?= isset($sourceFields) ? $sourceFields : "[]" ?>;
    window.mobbexFeaturedPlans     = <?= isset($featured_plans) ? json_encode($featured_plans) : "[]" ?>;
    window.mobbexAdvancedPlans     = <?= isset($advanced_plans) ? json_encode($advanced_plans) : "[]" ?>;
    window.mobbexManual            = Boolean(<?= isset($manual_config) ? $manual_config == "yes" : 0 ?>);
    window.mobbexShowFeaturedPlans = Boolean(<?= isset($show_featured) ? $show_featured == "yes" : 0 ?>);
</script>
<script src="<?= $block->getViewFileUrl('Mobbex_Webpay::js/plans-configurator.min.js') ?>"></script>